#!/bin/sh

USAGE="usage: ${CMD:=${0##*/}} ((-s|--status) | (-c|--connect) | (-r|--reconnect) | (-d|--disconnect) | --reinstall)"

# Options functions.
optexit () { printf >&2 "%s %s\n%s\n" "$1" "$2" "$USAGE"; exit 2; }
optcheck () { { [ "$1" != "$EOL" ] && [ "$1" != '--' ]; } || optexit "missing argument" "$2"; } # avoid infinite loop
opthelp () { printf "%s\n" "$USAGE"; }

# Parse command-line options.
set -- "$@" "${EOL:=$(printf '\1\3\3\7')}"  # end-of-list marker
while [ "$1" != "$EOL" ]; do
    opt="$1"; shift

    case "$opt" in
        -s | --status     ) opt_status='true';;
        -c | --connect    ) opt_connect='true';;
        -r | --reconnect  ) opt_reconnect='true';;
        -d | --disconnect ) opt_disconnect='true';;
        --reinstall       ) opt_reinstall='true';;
        -h | --help       ) opthelp; exit 0;;

        # Process special cases.
        --) while [ "$1" != "$EOL" ]; do set -- "$@" "$1"; shift; done;;   # parse remaining as positional
        --[!=]*=*) set -- "${opt%%=*}" "${opt#*=}" "$@";;                  # "--opt=arg"  ->  "--opt" "arg"
        -[A-Za-z0-9] | -*[!A-Za-z0-9]*) optexit "unknown option:" "$opt";; # anything invalid like '-*'
        -?*) other="${opt#-?}"; set -- "${opt%$other}" "-${other}" "$@";;  # "-abc"  ->  "-a" "-bc"
        *) set -- "$@" "$opt";;                                            # positional, rotate to the end
    esac
done; shift


if [ "$opt_connect" = 'true' ]; then
    # globalprotect connect --portal vpn.bank.ozon.ru || exit 1
    globalprotect connect --portal vpn.ecom-bank.ozon.ru || exit 1

elif [ "$opt_reconnect" = 'true' ]; then
    globalprotect rediscover-network || exit 1

elif [ "$opt_disconnect" = 'true' ]; then
    globalprotect disconnect || exit 1

elif [ "$opt_reinstall" = 'true' ]; then
    sudo aptitude remove globalprotect || exit 1
    sh -c 'printf '"'"'<?xml version="1.0" encoding="UTF-8"?>\n<GlobalProtect>\n\t<PanMSAgent>\n\t\t<DebugLevel>5</DebugLevel>\n\t\t<CDLLog>0</CDLLog>\n\t\t<PanGPS>5</PanGPS>\n\t</PanMSAgent>\n\t<Settings>\n\t\t<ConfFromPortal>7212</ConfFromPortal>\n\t\t<ConfFromPortal3>22635233</ConfFromPortal3>\n\t\t<OverrideMethod>allowed</OverrideMethod>\n\t\t<LastUrl>vpn.bank.ozon.ru</LastUrl>\n\t\t<HipCheckInterval>0</HipCheckInterval>\n\t\t<UserOverrides>0</UserOverrides>\n\t\t<DisallowLocalAccess>false</DisallowLocalAccess>\n\t\t<DisplayWelcome>1</DisplayWelcome>\n\t\t<LocalBioEnabled>0</LocalBioEnabled>\n\t\t<LocalSSLEnabled>0</LocalSSLEnabled>\n\t\t<DisplayTrafficBlockingMsg>1</DisplayTrafficBlockingMsg>\n\t\t<OtherDisableStarted>0</OtherDisableStarted>\n\t\t<agent-user-override-timeout>0</agent-user-override-timeout>\n\t\t<ssl-only-selection>0</ssl-only-selection>\n\t\t<mfa-prompt-suppress-time>0</mfa-prompt-suppress-time>\n\t\t<Configurations2>47</Configurations2>\n\t\t<Configurations3>0</Configurations3>\n\t\t<InitRun>0</InitRun>\n\t\t<Configurations>2</Configurations>\n\t</Settings>\n\t<Settings\vpn.ecom-bank.ozon.ru>\n\t\t<WasOD>1</WasOD>\n\t</Settings\vpn.ecom-bank.ozon.ru>\n\t<Settings\vpn-a.ecom-bank.ozon.ru>\n\t\t<WasOD>1</WasOD>\n\t</Settings\vpn-a.ecom-bank.ozon.ru>\n\t<Settings\vpn.bank.ozon.ru>\n\t\t<LatestCP/>\n\t\t<username/>\n\t\t<WasOD>1</WasOD>\n\t</Settings\vpn.bank.ozon.ru>\n</GlobalProtect>'"'"' > ~/.GlobalProtect/pangpa.xml' || exit 1
    sudo sh -c 'printf '"'"'<?xml version="1.0" encoding="UTF-8"?>\n<GlobalProtect>\n\t<Settings>\n\t\t<default-browser>yes</default-browser>\n\t\t<disable-globalprotect>0</disable-globalprotect>\n\t</Settings>\n\t<PanSetup>\n\t\t<InstallHistory>Fresh Install</InstallHistory>\n\t\t<CurrentVersion>6.0.1-6</CurrentVersion>\n\t\t<PreviousVersion/>\n\t</PanSetup>\n\t<PanGPS>\n\t\t<UserProfileType>0</UserProfileType>\n\t\t<disable-globalprotect>0</disable-globalprotect>\n\t</PanGPS>\n</GlobalProtect>'"'"' > /opt/paloaltonetworks/globalprotect/pangps.xml' || exit 1
    sudo sh -c 'printf '"'"'<?xml version="1.0" encoding="UTF-8"?>\n<GlobalProtect>\n\t<Settings>\n\t\t<default-browser>yes</default-browser>\n\t\t<disable-globalprotect>0</disable-globalprotect>\n\t\t<regioncode>RU</regioncode>\n\t</Settings>\n\t<PanSetup>\n\t\t<InstallHistory>Fresh Install</InstallHistory>\n\t\t<CurrentVersion>6.0.1-6</CurrentVersion>\n\t\t<PreviousVersion/>\n\t</PanSetup>\n\t<PanGPS>\n\t\t<UserProfileType>0</UserProfileType>\n\t\t<disable-globalprotect>0</disable-globalprotect>\n\t</PanGPS>\n</GlobalProtect>'"'"' > /opt/paloaltonetworks/globalprotect/pangs.xml' || exit 1
    sudo sh -c 'printf '"'"'[Desktop Entry]\nName=GlobalProtect\nExec=/usr/bin/globalprotect defaultbrowser %u\nType=Application\nNoDisplay=true\nMimeType=x-scheme-handler/globalprotectcallback;'"'"' > /usr/share/applications/gp.desktop' || exit 1
    update-desktop-database || exit 1
    sudo dpkg --install ~/Downloads/GlobalProtect_deb-6.0.1.1-6.deb || exit 1

elif [ "$opt_status" != 'true' ]; then
    opthelp && exit 0 || exit 1
fi

globalprotect show --status
