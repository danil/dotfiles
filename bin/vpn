#!/bin/sh -e

USAGE="usage: ${CMD:=${0##*/}} ((-s|--status) | (-c|--connect) | (-r|--reconnect) | --reset | (-d|--disconnect))"

# Options functions.
optexit () { printf >&2 "%s %s\n%s\n" "$1" "$2" "$USAGE"; exit 2; }
optcheck () { { [ "$1" != "$EOL" ] && [ "$1" != '--' ]; } || optexit "missing argument" "$2"; }  # avoid infinite loop

# Parse command-line options.
set -- "$@" "${EOL:=$(printf '\1\3\3\7')}"  # end-of-list marker
while [ "$1" != "$EOL" ]; do
    opt="$1"; shift

    case "$opt" in
        -s | --status     ) opt_status=true;;
        -c | --connect    ) opt_connect=true;;
        -r | --reconnect  ) opt_reconnect=true;;
        --reset           ) opt_reset=true;;
        -d | --disconnect ) opt_disconnect=true;;
        -h | --help       ) printf "%s\n" "$USAGE"; exit 0;;

        # Process special cases.
        --) while [ "$1" != "$EOL" ]; do set -- "$@" "$1"; shift; done;;   # parse remaining as positional
        --[!=]*=*) set -- "${opt%%=*}" "${opt#*=}" "$@";;                  # "--opt=arg"  ->  "--opt" "arg"
        -[A-Za-z0-9] | -*[!A-Za-z0-9]*) optexit "unknown option:" "$opt";; # anything invalid like '-*'
        -?*) other="${opt#-?}"; set -- "${opt%$other}" "-${other}" "$@";;  # "-abc"  ->  "-a" "-bc"
        *) set -- "$@" "$opt";;                                            # positional, rotate to the end
    esac
done; shift


if [ "$opt_connect" = true ]; then
    globalprotect connect --portal vpn.ecom-bank.ozon.ru || exit 1

elif [ "$opt_reconnect" = true ]; then
    globalprotect rediscover-network || exit 1

elif [ "$opt_reset" = true ]; then
    sudo aptitude remove globalprotect || exit 1
    cd
    git checkout .GlobalProtect/pangpa.xml || exit 1
    cd -
    cd /
    sudo git checkout usr/share/applications/gp.desktop || exit 1
    sudo git checkout opt/paloaltonetworks/globalprotect/pangs.xml || exit 1
    sudo git checkout opt/paloaltonetworks/globalprotect/pangps.xml || exit 1
    sudo dpkg --install ~/Downloads/GlobalProtect_deb-6.0.1.1-6.deb || exit 1
    cd -
    echo "new portal: vpn.bank.ozon.ru"
    echo "old portal: vpn.ecom-bank.ozon.ru"

elif [ "$opt_disconnect" = true ]; then
    globalprotect disconnect || exit 1

elif [ "$opt_status" != true ]; then
    printf "%s\n" "$USAGE"; exit
fi

globalprotect show --status
