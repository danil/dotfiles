#!/usr/bin/env sh

# This file is part of Danil Kutkevich <danil@kutkevich.org> home.

USAGE="usage: ${CMD:=${0##*/}} --top"

OPT_DRY=0

# Shell script options functions.
opttest () { { [ "$1" != "$EOL" ] && [ "$1" != '--' ]; } || optexit "missing argument" "$2"; } # avoid infinite loop
opthelp () { printf "%s\n" "$USAGE"; }
optexit () { printf >&2 "%s %s\n%s\n" "$1" "$2" "$USAGE"; exit 2; }

# Parse command-line options.
set -- "$@" "${EOL:=$(printf '\1\3\3\7')}"  # end-of-list marker
while [ "$1" != "$EOL" ]; do
    opt="$1"; shift

    case "$opt" in
        --top ) OPT_TOP=0;;
        --presentation-mode) OPT_PRE=0;;
        -h | --help ) opthelp; exit 0;;

        # Process special cases.
        --) while [ "$1" != "$EOL" ]; do set -- "$@" "$1"; shift; done;;    # parse remaining as positional
        --[!=]*=*) set -- "${opt%%=*}" "${opt#*=}" "$@";;                   # "--opt=arg"  ->  "--opt" "arg"
        -[A-Za-z0-9] | -*[!A-Za-z0-9]*) optexit "unknown option:" "$opt";;  # anything invalid like '-*'
        -?*) other="${opt#-?}"; set -- "${opt%"$other"}" "-${other}" "$@";; # "-abc"  ->  "-a" "-bc"
        *) set -- "$@" "$opt";;                                             # positional, rotate to the end
    esac
done; shift

if [ "$OPT_TOP" = 0 ]; then
    # printf "%s" "$(randomaccessmemory)"
    # printf " "
    # printf "%sÂ°" "$(coretemperature)"
    printf "%s" "$(loadaverage)"
    OPT_DRY=-1
fi

if [ "$OPT_PRE" = 0 ]; then
    s="$(xfcepresentationmode1)"
    # [ -n "$s" ] && [ "$OPT_DRY" = -1 ] && printf " "
    printf "%s" "$s"
    OPT_DRY=-1
fi

# Dry run.
if [ "$OPT_DRY" = 0 ]; then
    printf "%s\n" "$USAGE"
    exit 1
fi
