#! /bin/bash

set -e

while [ $# -gt 0 ]; do
    case "$1" in
        --file=*)
            file="${1#*=}"
            ;;
        *)
            (>&2 echo 'Invalid argument')
            exit 1
    esac
    shift
done

if [[ -z  $file ]]; then
    (>&2 echo 'File name argument is missing') ; exit 1
fi

if ! [[ $file = *[!\ ]* ]]; then
    (>&2 echo "Invalid file name argument: $file") ; exit 1
fi

if ! [ -f "./${file}.gz" ]; then
    (>&2 echo "Nothing to encrypt. File ${file}.gz not found!") ; exit 1
fi

if [ -f "./${file}.gz.asc" ]; then
    mv -i "./${file}.gz.asc" "./${file}$(date --utc +%Y%m%dT%H%M%SZ).gz.asc"
fi

gpg --symmetric --armor "./${file}.gz" || exit 1
