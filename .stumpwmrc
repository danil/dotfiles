;;; This file is part of Danil Kutkevich <danil@kutkevich.org> home.

(in-package :stumpwm)

;;; Variables.
(defparameter X-TERM "urxvt"
  "What shall be the command run when we want an X terminal?")
(defparameter HOME-DIR (getenv "HOME"))
(defparameter DATE-FORMAT "+%R %d-%b-%y")
(defparameter BACKGROUND "~/local/share/backgrounds/gentoo-znurt-larry-abducted-1440x900.png")
(defparameter CURSOR-NAME "Vanilla-DMZ")
(defparameter SHOW-CPU-LOAD "bin/show_cpu_load.sh")
(defparameter SHOW-BATTERY-STATUS "bin/show_battery_status.sh")
(defparameter CONTRIB-DIR (merge-pathnames "src/vendor/cl/stumpwm-contrib/"
                               (user-homedir-pathname)))
(defparameter MY-PACKAGES '(
                            "util/stumptray/"
                            ))

(set-prefix-key (kbd "M-m"))

;; Terminal emulator.
(define-key *root-map* (kbd "c") (concat "exec " X-TERM))

;;; Commands
;;; <http://paste.lisp.org/display/75796>.
;; Select group and echo group nickname.
;; ;; Show CPU load.
;; (defcommand show-cpu-load () ()
;;   (message "~a" (run-shell-command
;;                  (concat HOME-DIR "/"  SHOW-CPU-LOAD) t)))
;; ;; Query ACPI and show the battery's status.
;; (defcommand show-battery-status () ()
;;   (message "~a" (run-shell-command
;;                  (concat HOME-DIR "/" SHOW-BATTERY-STATUS) t)))

;; Groups.
(setf (group-name (first (screen-groups (current-screen)))) "1") ;rename the first group "Default" to "1" <http://en.wikipedia.org/wiki/User:Gwern/.stumpwmrc>
;; Create a new groups but do not switch to it.
(gnewbg "2")
(gnewbg "3")
(gnewbg "4")
(gnewbg "5")
(gnewbg "6")
(gnewbg "7")
(gnewbg "8")
(gnewbg "9")

(defcommand dmenu-run () () (run-shell-command "dmenu_run -b"))
(defcommand set-keyboard-auto-repeat () ()
  (run-shell-command "xset r rate 300 30")) ;set the keyboard auto repeat parameters
(defcommand set-terminal-bell () ()
  (run-shell-command "xset b off")) ;turn off bell
(defcommand set-background (background) ()
  (run-shell-command (concatenate 'string "feh --bg-center " background)))
(defcommand set-cursor-name (cursor-name) ()
  (run-shell-command (concatenate 'string "xsetroot -cursor_name " cursor-name))) ;<https://github.com/stumpwm/stumpwm/wiki/FAQ#why-is-the-mouse-pointer-an-x-and-how-do-i-change-it>
(defcommand run-power-manager () () (run-shell-command "xfce4-power-manager"))
(defcommand run-wireless-manager () ()
  (run-shell-command
   (concatenate 'string
                "pkill -f /usr/share/wicd/gtk/wicd-client.py ; "
                "wicd-gtk --tray")))
(defcommand run-volume-daemon () ()
  (run-shell-command "killall xfce4-volumed ; xfce4-volumed"))
(defcommand run-dictionary () ()
  (run-shell-command "killall stardict ; stardict --hide"))

;;; Key binding.
;; (define-key *root-map* (kbd "C-q") "show-battery-status") ;battery status
;; (define-key *root-map* (kbd "q") "show-cpu-load") ;cpu load
;; (define-key *top-map* (kbd "C-M-G") "vgroups") ;groups (virtual desktops or workspaces) <http://nongnu.org/stumpwm/manual/stumpwm_8.html>
(define-key *top-map* (kbd "C-M-M") "mode-line") ;mode line <http://nongnu.org/stumpwm/manual/stumpwm_7.html>
(define-key *root-map* (kbd "!") "dmenu-run")

(setf *screen-mode-line-format*
      (list "[^B%n^b] "
            "%W "
            "^>" ;right align
            '(:eval (run-shell-command
                     (format nil "date '~a' | tr -d [:cntrl:]"
                             DATE-FORMAT) t))
            "      "))

(setq *mode-line-position* :bottom)

(dolist (my-package MY-PACKAGES)
  (let ((my-path (merge-pathnames my-package CONTRIB-DIR)))
    (when (probe-file my-path)
      (push my-path asdf:*central-registry*))))

;; (let ((quicklisp-init (merge-pathnames "src/vendor/cl/stumpwm-contrib/media/amixer/amixer.lisp"
;;                                        (user-homedir-pathname))))
;;   (when (probe-file quicklisp-init)
;;     (load quicklisp-init)))

(ql:quickload "stumptray") ;<https://github.com/stumpwm/stumpwm-contrib/blob/master/util/stumptray/README.org>.
(run-commands "stumptray")

(set-keyboard-auto-repeat)
(set-background BACKGROUND)
(set-cursor-name CURSOR-NAME)
(run-power-manager)
(run-wireless-manager)
(run-volume-daemon)
(run-dictionary)
(set-terminal-bell)
